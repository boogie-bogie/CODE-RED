<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CODE:RED</title>
    <style>
      * {
        width: 440px;
        margin: 0 auto;
        padding: 5px;
      }

      #divide {
        height: 0px;
        border-bottom: solid 2px red;
      }

      body {
        font-family: sans-serif;
        background-color: white;
        color: black;
        text-align: center;
      }

      #corong-image {
        width: 170px;
        height: 150px;
        margin-bottom: 20px;
        display: flex;
        padding-top: 20px;
      }

      /*header*/

      header {
        color: red;
        padding: 20px;
        text-align: center;
        display: flex;
        padding-bottom: 0px;
      }

      h2 {
        font-size: 24px;
        color: green;
        padding-top: 20px;
      }

      #sos {
        height: 30px;
        background-color: red;
        color: white;
        width: 40px;
        cursor: pointer;
        border-radius: 5px;
        margin-top: 5px;
      }

      /*footer*/
      footer {
        padding: 2px;
        display: flex;
        position: fixed;
        bottom: 0;
        width: 440px;
        height: 30px;
        margin: 20px;
      }

      #user-location, #closest-shelter {
        font-weight: bold;
        font-size: 17px;
      }
      #population, #disaster, #accident {
        font-size: 19px;
      }
      #time {
        text-align: end;
      }
      
      #inputButton {
        display: flex;
        gap: 5px;
        margin-top: 15px
      }
      #searchInput {
        background-color: #2196F3;
        border-radius: 7px;
        border: 1px solid white;
      }
      #searchInput::placeholder {
        color : white;
        padding-left: 5px;
      }
      #searchButton {
        width: 100px;
        height: 50px;
        background-color: #2196F3;
        border-radius: 7px;
        border: 1px solid white;
        color : white;
      }

      .button {
        background-color: white;
        color: black;
        border: solid 1px black;
        border-radius: 8px;
        cursor: pointer;
        width: 60px;
      }

      .footer-image {
        width: 25px;
        height: 25px;
      }

      .header-image {
        width: 30px;
        height: 30px;
      }
    </style>
    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        // 전역으로 쓸 변수들 먼저 선언
        let congestScore;
        let disasterScore;
        let riskLevelElement = document.getElementById('riskLevel')
        let corongImage = document.getElementById('corong-image');
        let congestStyle = document.getElementById('congest')
        let transitionStyle = document.getElementById('transition')

        try{
          const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject)
        })

        let lat = position.coords.latitude, // 위도
            lon = position.coords.longitude; // 경도
          
        // 나의 현재 위치 & 인구 밀집,인구 추이, 기준 시간
        const url = `http://localhost:3000/destination-risk/coordinate?x=${lon}&y=${lat}`;
        const response = await fetch(url)
        const locationData = await response.text()
            if (!locationData.length) {
              alert('위치 정보를 받아오지 못했습니다.');
            } else {
              let myLocation = document.getElementById('user-location');
              myLocation.innerHTML = '나의 현재 위치 : ' + locationData;

              const populationCongestTransitionUrl = `http://localhost:3000/destination-risk/check?destination=${locationData}`
              const response = await fetch(populationCongestTransitionUrl)
              const populationData = await response.json()
                if (!populationData) {
                  alert('데이터를 찾지 못했습니다.');
                } else {
                  congestScore = 0

                  // '실시간 장소 혼잡도' 값에 따라 점수 부여
                  switch(populationData['실시간 장소 혼잡도']) {
                    case '여유': congestScore = 0
                    congestStyle.style.color = 'green'
                    transitionStyle.style.color = 'green'
                    break
                    case '보통': congestScore = 1
                    congestStyle.style.color = 'deepskyblue'
                    transitionStyle.style.color = 'deepskyblue'
                    break
                    case '약간 붐빔': congestScore = 3
                    congestStyle.style.color = 'orange'
                    transitionStyle.style.color = 'orange'
                    break
                    case '붐빔': congestScore = 5
                    congestStyle.style.color = 'red'
                    transitionStyle.style.color = 'red'
                    break
                    default: congestScore = null,
                    console.log('알 수 없는 혼잡도 상태입니다.')
                  }
                  console.log("--congestScore--",congestScore)

                  let closestLocationCongest = document.getElementById('congest')
                  closestLocationCongest.innerHTML = populationData['실시간 장소 혼잡도']
                  let populationTransition = document.getElementById('transition')
                  populationTransition.innerHTML = populationData['예상 인구']
                  let standardTime = document.getElementById('time')
                  standardTime.innerHTML = populationData['기준 시간']
                }
              }
          // 내 위치에서 가장 가까운 대피소
          const requestShelterUrl = `http://localhost:3000/shelters/nearby?x=${lon}&y=${lat}`;
          const responseData = await fetch(requestShelterUrl)
          let shelterData = await responseData.json()
          if (!shelterData.facility_name) {
            alert('가까운 대피소를 찾지 못했습니다.');
          } else {
            let closestShelter = document.getElementById('closest-shelter')
            closestShelter.innerHTML = `가까운 대피소 : ${shelterData.facility_name}`
          }

          // 사건 사고
          const accidentUrl = `http://localhost:3000/news/accident`
          const responseNews = await fetch(accidentUrl)
          let newsData = await responseNews.json()
          console.log("-------",newsData)

          // 재난 현황
          const disasterUrl = `http://localhost:3000/disaster/data`
          const responseDisaster = await fetch(disasterUrl)
          let disasterData = await responseDisaster.json()
          const filteredDisasterData = disasterData.filter(data => {
              const hasSeoul = data.locationName.includes('서울특별시')
              const keywords = ['지진', '산불', '태풍', '홍수', '지진해일', '전염병', '테러', '폭동'];
              const containsKeyword = keywords.some(keyword => data.message.includes(keyword));
              return hasSeoul && containsKeyword;
          })
          // 필터링 된 재난 데이터가 없을 경우
          if (!filteredDisasterData.length) {
            let emptyDisaster = document.getElementById('calamity')
            disasterScore = 0
            emptyDisaster.innerHTML = '0건'
            let totalScore = congestScore + disasterScore;
            console.log("---total---",totalScore)

            if (totalScore >= 0 && totalScore <= 3) {
              riskLevelElement.innerHTML = '안전'
              riskLevelElement.style.color = 'darkolivegreen'
              corongImage.src = 'https://postfiles.pstatic.net/MjAyNDA0MjBfMTgg/MDAxNzEzNjA2NDg3MzI3.sKvYltmXJ46If2ypG6IBHs8DKf22ogQWF8W9DwbKp7Mg.Hx7frtbDo3Lt2WDbaAwb5p1EhQhh_-CbshWOHSEwh40g.PNG/%EC%BD%94%EB%A1%B1%EC%9D%B4_%EA%B7%B8%EB%A6%B0.png?type=w580';
            } else if (totalScore >= 4 && totalScore <= 6) {
                riskLevelElement.innerHTML = '보통'
                riskLevelElement.style.color = 'deepskyblue'
                corongImage.src = 'https://postfiles.pstatic.net/MjAyNDA0MjBfMjQg/MDAxNzEzNjA2NDkyNDI2.tR15Dv8bUiN8O6wEuuUkRgRtdxjv3yYSwTPRz-4G66gg.y9_pGy2eZ4o1ISoLhQzC1itG7HyktBmH3n2oj5LV36wg.PNG/%EC%BD%94%EB%A1%B1%EC%9D%B4_%EC%8A%A4%EC%B9%B4%EC%9D%B4%EB%B8%94%EB%A3%A8.png?type=w580';
              } else if (totalScore >= 7 && totalScore <= 11) {
                riskLevelElement.innerHTML = '약간 위험'
                riskLevelElement.style.color = 'orange'
                corongImage.src = 'https://postfiles.pstatic.net/MjAyNDA0MjBfNjQg/MDAxNzEzNjA2NDk3NDY0.OfArP4BsxiSy79JghC6OOcxLO3lUqzo5QGuzeZMwTXsg.7AsKH6ExROwijk092ZrPbAu_kiRSHENPB56lL-MuHDgg.PNG/%EC%BD%94%EB%A1%B1%EC%9D%B4_%EC%98%A4%EB%A0%8C%EC%A7%80.png?type=w580'
              } else if (totalScore >= 12) {
                riskLevelElement.innerHTML = '매우 위험'
                riskLevelElement.style.color = 'red'
                corongImage.src = 'https://postfiles.pstatic.net/MjAyNDA0MjBfMTA2/MDAxNzEzNjA2NDk5Nzk2.RFnFMYJw-yNigAbQXpE9n4oHzhQDZVYYZwRcvy51m0sg.U8rK9fI9Tbd7VP3KsCI4M8-DyMUhLH4gIWPRScnVZM4g.PNG/%EC%BD%94%EB%A1%B1%EC%9D%B4_%EB%A0%88%EB%93%9C.png?type=w580'
              } else {
              console.log('유효하지 않은 totalScore 값입니다.')
              }
          }
          // 필터링된 데이터가 존재할 경우
          else {
            const scoreDisasterData = filteredDisasterData.map(data => {
              disasterScore = 0
              if (data.message.includes('산불')) {
                disasterScore += 4
              }
              if (data.message.includes('태풍') || data.message.includes('홍수')) {
                disasterScore += 6
              }
              if (data.message.includes('지진') || data.message.includes('전염병')) {
                disasterScore += 8
              }
              if (data.message.includes('지진해일')) {
                disasterScore += 10
              }
              return {...data, disasterScore}
            })
            console.log("--scoreDisasterData--",scoreDisasterData.disasterScore)
            // 점수 합산, 문구 변경, 안전:0~3점, 보통:4~6점, 약간위험: 7~11점, 매우위험:12~ 로 설정
            let totalScore = congestScore + disasterScore;
            console.log("---total---",totalScore)

            if (totalScore >= 1 && totalScore <= 3) {
              riskLevelElement.innerHTML = '안전'
              riskLevelElement.style.color = 'green'
              corongImage.src = 'https://postfiles.pstatic.net/MjAyNDA0MjBfMTgg/MDAxNzEzNjA2NDg3MzI3.sKvYltmXJ46If2ypG6IBHs8DKf22ogQWF8W9DwbKp7Mg.Hx7frtbDo3Lt2WDbaAwb5p1EhQhh_-CbshWOHSEwh40g.PNG/%EC%BD%94%EB%A1%B1%EC%9D%B4_%EA%B7%B8%EB%A6%B0.png?type=w580';
            } else if (totalScore >= 4 && totalScore <= 6) {
              riskLevelElement.innerHTML = '보통'
              riskLevelElement.style.color = 'blue'
              corongImage.src = 'https://postfiles.pstatic.net/MjAyNDA0MjBfMjQg/MDAxNzEzNjA2NDkyNDI2.tR15Dv8bUiN8O6wEuuUkRgRtdxjv3yYSwTPRz-4G66gg.y9_pGy2eZ4o1ISoLhQzC1itG7HyktBmH3n2oj5LV36wg.PNG/%EC%BD%94%EB%A1%B1%EC%9D%B4_%EC%8A%A4%EC%B9%B4%EC%9D%B4%EB%B8%94%EB%A3%A8.png?type=w580';
            } else if (totalScore >= 7 && totalScore <= 11) {
              riskLevelElement.innerHTML = '약간 위험'
              riskLevelElement.style.color = 'orange'
              corongImage.src = 'https://postfiles.pstatic.net/MjAyNDA0MjBfNjQg/MDAxNzEzNjA2NDk3NDY0.OfArP4BsxiSy79JghC6OOcxLO3lUqzo5QGuzeZMwTXsg.7AsKH6ExROwijk092ZrPbAu_kiRSHENPB56lL-MuHDgg.PNG/%EC%BD%94%EB%A1%B1%EC%9D%B4_%EC%98%A4%EB%A0%8C%EC%A7%80.png?type=w580'
            } else if (totalScore >= 12) {
              riskLevelElement.innerHTML = '매우 위험'
              riskLevelElement.style.color = 'red'
              corongImage.src = 'https://postfiles.pstatic.net/MjAyNDA0MjBfMTA2/MDAxNzEzNjA2NDk5Nzk2.RFnFMYJw-yNigAbQXpE9n4oHzhQDZVYYZwRcvy51m0sg.U8rK9fI9Tbd7VP3KsCI4M8-DyMUhLH4gIWPRScnVZM4g.PNG/%EC%BD%94%EB%A1%B1%EC%9D%B4_%EB%A0%88%EB%93%9C.png?type=w580'
            } else {
              totalScore = '알 수 없는 점수';
            }
            // 지진,전염병,지진해일 발생시 메세지 표시
            filteredDisasterData.forEach(data => {
              if (data.message.includes('지진') || data.message.includes('전염병') || data.message.includes('지진해일')) {
                const emergencyElement = document.getElementById('emergency')
                emergencyElement.innerHTML = data.message + '<br>'
              }
            });
          }       
        } catch (error) {
          console.error('위치 정보 접근이 거부되거나 에러가 발생했습니다.:', error)
        }
      document.getElementById('searchButton').addEventListener('click', () => {
        let searchInput = document.getElementById('searchInput').value
        let url = `./destination-detail.html?destination=${encodeURIComponent(searchInput)}`
        window.location.href = url
      })
  })
    </script>
  </head>
  <body>
    <header><!-- sos,notification과 연결하는 파일 못찾아서 추가 해야함-->
      <image
        src="./images/free-icon-notification-3119322.png"
        class="header-image"
      ></image>
      <h1>CODE:RED</h1>
      <button id="sos">sos</button>
    </header>

    <main>
      <p id="divide"></p>
      <br />

      <div id="user-location">나의 현재 위치 : </div>

      <div id="closest-shelter">가까운 대피소 : </div>

      <div id="emergency" style="width: 450px; max-height: 120px; font-weight: bold; font-size: 24px; color: red;"></div>

      <h2 id="riskLevel">CODE : RED</h2>
      <img
        src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FoFvs6%2FbtsGHblHYxt%2F1kXhsa7cOG2FcjC2UzUIF1%2Fimg.png"
        alt="프로필 사진"
        id="corong-image"
      />

      <table>
        <tr>
          <th id="population">인구 밀집</th>
          <th id="population">인구 추이</th>
          <th id="disaster">재난 현황</th>
          <th id="accident">사건 / 사고</th>
        </tr>

        <tr>
          <td id="congest">CODE : RED</td>
          <td id="transition">CODE : RED</td>
          <td id="calamity">CODE : RED</td>
          <td>CODE : RED</td>
        </tr>
      </table>
      <div style="color: gray" id="time">위험도 측정 기준 : CODE : RED</div>
    </main>

    <form action="" id="inputButton">
      <input
        type="text, submit"
        id="searchInput"
        placeholder="이동할 목적지를 입력해주세요."
      />
      <button id="searchButton" type="button" >검색</button>
    </form>

    <footer>
      <a href="./main.html"
        ><image
          src="./images/free-icon-home-4690939.png"
          class="footer-image"
        ></image
      ></a>
      <a href="./findshelter.html"
        ><image
          src="./images/free-icon-search-149852.png"
          class="footer-image"
        ></image
      ></a>
      <a href="./chat-list.html"
        ><image
          src="./images/free-icon-bubble-chat-2076218.png"
          class="footer-image"
        ></image
      ></a>
      <a href="./exchange.html"
        ><image
          src="./images/free-icon-exchange-9788303.png"
          class="footer-image"
        ></image
      ></a>
      <a href="./myinfo.html"
        ><image
          src="./images/free-icon-user-3856336.png"
          class="footer-image"
        ></image
      ></a>
    </footer>
  </body>
</html>
