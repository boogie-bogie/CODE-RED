<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CODE:RED</title>
    <style>
      * {
        width: 440px;
        margin: 0 auto;
        padding: 5px;
      }

      #divide {
        height: 0px;
        border-bottom: solid 2px red;
      }

      body {
        font-family: sans-serif;
        background-color: white;
        color: black;
        text-align: center;
      }

      #corong-image {
        width: 170px;
        height: 150px;
        margin-bottom: 20px;
        display: flex;
        padding-top: 20px;
      }

      /*header*/

      header {
        color: red;
        padding: 20px;
        text-align: center;
        display: flex;
        padding-bottom: 0px;
      }

      h2 {
        font-size: 24px;
        color: green;
        padding-top: 20px;
      }

      #sos {
        height: 30px;
        background-color: red;
        color: white;
        width: 40px;
        cursor: pointer;
        border-radius: 5px;
        margin-top: 5px;
      }

      /*footer*/
      footer {
        padding: 2px;
        display: flex;
        position: fixed;
        bottom: 0;
        width: 440px;
        height: 30px;
        margin: 20px;
      }

      #user-location, #closest-shelter {
        font-weight: bold;
        font-size: 17px;
      }
      #population, #disaster, #accident {
        font-size: 19px;
      }
      #time {
        text-align: end;
      }
      
      #inputButton {
        display: flex;
        gap: 5px;
        margin-top: 15px
      }
      #searchInput {
        background-color: #2196F3;
        border-radius: 7px;
        border: 1px solid white;
      }
      #searchInput::placeholder {
        color : white;
        padding-left: 5px;
      }
      #searchButton {
        width: 100px;
        height: 50px;
        background-color: #2196F3;
        border-radius: 7px;
        border: 1px solid white;
        color : white;
      }

      .button {
        background-color: white;
        color: black;
        border: solid 1px black;
        border-radius: 8px;
        cursor: pointer;
        width: 60px;
      }

      .footer-image {
        width: 25px;
        height: 25px;
      }

      .header-image {
        width: 30px;
        height: 30px;
      }
    </style>
    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        // 전역으로 쓸 변수들 먼저 선언
        let locationData;
        let populationData;
        let congestScore;
        let accidentScore;
        let totalScore;
        let emergencyElement = document.getElementById('emergency');
        let riskLevelElement = document.getElementById('riskLevel');
        let corongImage = document.getElementById('corong-image');
        let congestStyle = document.getElementById('congest');
        let transitionStyle = document.getElementById('transition');

        try{
          const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject)
        })

        let lat = position.coords.latitude, // 위도
            lon = position.coords.longitude; // 경도
          
        // 나의 현재 위치 & 인구 밀집,인구 추이, 기준 시간
        const url = `http://localhost:3000/destination-risk/coordinate?x=${lon}&y=${lat}`;
        const response = await fetch(url)
        locationData = await response.text()
            if (!locationData.length) {
              alert('위치 정보를 받아오지 못했습니다.');
            } else {
              let myLocation = document.getElementById('user-location');
              myLocation.innerHTML = '나의 현재 위치 : ' + locationData;

              const populationCongestTransitionUrl = `http://localhost:3000/destination-risk/check?destination=${encodeURIComponent(locationData)}`
              const response = await fetch(populationCongestTransitionUrl)
              populationData = await response.json()
                if (!populationData['기준 장소']) {
                  alert('데이터를 찾지 못했습니다.');
                  let emptyCongest = document.getElementById('congest')
                  let emptyTransition = document.getElementById('transition')
                  emptyCongest.innerHTML = '주변 데이터가 없습니다.'
                  emptyTransition.innerHTML = '주변 데이터가 없습니다.'
                } else {
                  congestScore = 0

                  // '실시간 장소 혼잡도' 값에 따라 점수 부여
                  let congestion = populationData['실시간 장소 혼잡도'];
                  if (congestion === '여유' || congestion === '보통') {
                    congestScore = 1;
                    congestStyle.style.color = 'green';
                    transitionStyle.style.color = 'green';
                  } else if (congestion === '약간 붐빔') {
                    congestScore = 2;
                    congestStyle.style.color = 'orange';
                    transitionStyle.style.color = 'orange';
                  } else if (congestion === '붐빔') {
                    congestScore = 3;
                    congestStyle.style.color = 'red';
                    transitionStyle.style.color = 'red';
                  } else {
                    congestScore = null;
                    console.log('알 수 없는 혼잡도 상태입니다.');
                  }

                  let closestLocationCongest = document.getElementById('congest')
                  closestLocationCongest.innerHTML = populationData['실시간 장소 혼잡도']
                  let populationTransition = document.getElementById('transition')
                  populationTransition.innerHTML = populationData['예상 인구']
                  let standardTime = document.getElementById('time')
                  standardTime.innerHTML = populationData['기준 시간']
                }
              }
        // 향후 non-seoul 재난 메세지를 위해 시,구 까지만 나오는 지역명 받아놓기
        const regionNameUrl = `http://localhost:3000/destination-risk/regionCoordinate?x=${lon}&y=${lat}`
        const responseRegion = await fetch(regionNameUrl)
        let regionName = await responseRegion.text()
        if (!regionName.length) {
          alert('지역 정보를 받아오지 못했습니다.');
        } else {
          console.log("지역 정보 받아오기 성공", regionName)
        }
            
        // 내 위치에서 가장 가까운 대피소
        const requestShelterUrl = `http://localhost:3000/shelters/nearby?x=${lon}&y=${lat}`;
        const responseData = await fetch(requestShelterUrl)
        let shelterData = await responseData.json()
        if (!shelterData.facility_name) {
          alert('가까운 대피소를 찾지 못했습니다.');
          let emptyShleter = document.getElementById('closest-shelter')
          emptyShleter.innerHTML = '가까운 대피소가 없습니다.'
        } else {
          let closestShelter = document.getElementById('closest-shelter')
          closestShelter.innerHTML = `가까운 대피소 : ${shelterData.facility_name}`
        }

        // 재난 현황
        const disasterUrl = `http://localhost:3000/disaster/data`
        const responseDisaster = await fetch(disasterUrl)
        let disasterData = await responseDisaster.json()
        const filteredDisasterData = disasterData.filter(data => {
            const hasSeoul = data.locationName.includes('서울특별시')
            const keywords = [
            '지진', '강풍', '호우', '산불', '태풍', '홍수', '지진해일', '전염병',
            '테러', '폭동', '건조', '산사태', '폭염', '안개', '풍량', '미세먼지',
            '대조기', '가뭄', '대설', '한파', '황사', '교통통제', '화재', '붕괴',
            '폭발', '교통사고', '환경 오염사고', '에너지', '통신', '교통', '금융',
            '의료', '수도', '정전', '가스', 'AI', '화생방사고', '비상사태', '민방공'
            ];
            const containsKeyword = keywords.some(keyword => data.message.includes(keyword));
            return hasSeoul && containsKeyword;
        })
        let nonSeoulFilteredDisasterData
        // 내 위치가 서울이 아닐 경우 그 지역의 메세지 출력
        if (!locationData.includes('서울')) {
          nonSeoulFilteredDisasterData = disasterData.filter(data => {
              const myRegion = data.locationName.includes(regionName)
              const keywords = [
              '지진', '강풍', '호우', '산불', '태풍', '홍수', '지진해일', '전염병',
              '테러', '폭동', '건조', '산사태', '폭염', '안개', '풍량', '미세먼지',
              '대조기', '가뭄', '대설', '한파', '황사', '교통통제', '화재', '붕괴',
              '폭발', '교통사고', '환경 오염사고', '에너지', '통신', '교통', '금융',
              '의료', '수도', '정전', '가스', 'AI', '화생방사고', '비상사태', '민방공'
              ];
              const containsKeyword = keywords.some(keyword => data.message.includes(keyword));
              return myRegion && containsKeyword;
          })
          // 필터링 된 재난 데이터가 없을 경우
          if (!nonSeoulFilteredDisasterData.length) {
            let emptyDisaster = document.getElementById('calamity')
            disasterScore = 0
            emptyDisaster.innerHTML = '0건 (서울이 아닌 해당 지역의 재난 데이터도 없습니다.)'
          }
          else {
            // 발생시 메세지 표시
            nonSeoulFilteredDisasterData.forEach(data => {
              emergencyElement = document.getElementById('emergency')
              const containsEmergencyKeyword = keywords.some(keyword => data.message.includes(keyword))
              if (containsEmergencyKeyword) {
                let emergencyEa = document.getElementById('calamity')
                emergencyEa.innerHTML = `${nonSeoulFilteredDisasterData.length}건`
                emergencyElement.innerHTML += data.message + '<br>';
                riskLevelElement.innerHTML = '위험'
                riskLevelElement.style.color = 'red'
                corongImage.src = 'https://postfiles.pstatic.net/MjAyNDA0MjBfMTA2/MDAxNzEzNjA2NDk5Nzk2.RFnFMYJw-yNigAbQXpE9n4oHzhQDZVYYZwRcvy51m0sg.U8rK9fI9Tbd7VP3KsCI4M8-DyMUhLH4gIWPRScnVZM4g.PNG/%EC%BD%94%EB%A1%B1%EC%9D%B4_%EB%A0%88%EB%93%9C.png?type=w580'
              }
            });
          }
        }
        // 서울 기준 필터링 된 재난 데이터가 없을 경우
        if (locationData.includes('서울') && !filteredDisasterData.length) {
          let emptyDisaster = document.getElementById('calamity')
          emptyDisaster.innerHTML = '0건'
          emptyDisaster.style.color = 'green'
        }
        // 서울 기준 필터링된 데이터가 존재할 경우
        else if (locationData.includes('서울') && !filteredDisasterData.length) {
          // 발생시 메세지 표시
          filteredDisasterData.forEach(data => {
            emergencyElement = document.getElementById('emergency')
            const containsEmergencyKeyword = keywords.some(keyword => data.message.includes(keyword))
            if (containsEmergencyKeyword) {
              let emergencyEa = document.getElementById('calamity')
              emergencyEa.innerHTML = `${filteredDisasterData.length}건`
              emergencyElement.innerHTML += data.message + '<br>';
              riskLevelElement.innerHTML = '위험'
              riskLevelElement.style.color = 'red'
              corongImage.src = 'https://postfiles.pstatic.net/MjAyNDA0MjBfMTA2/MDAxNzEzNjA2NDk5Nzk2.RFnFMYJw-yNigAbQXpE9n4oHzhQDZVYYZwRcvy51m0sg.U8rK9fI9Tbd7VP3KsCI4M8-DyMUhLH4gIWPRScnVZM4g.PNG/%EC%BD%94%EB%A1%B1%EC%9D%B4_%EB%A0%88%EB%93%9C.png?type=w580'
            }
          });
        }

        // 사건 사고
        const accidentUrl = `http://localhost:3000/news/accident`
        const responseNews = await fetch(accidentUrl)
        let newsData = await responseNews.json()

        // 사건 사고 뉴스가 없다면
        if (newsData.length === 0) {
          let emptyAccident = document.getElementById('incident')
          accidentScore = 0
          emptyAccident.innerHTML = '0건'
          emptyAccident.style.color = 'green'
          totalScore = congestScore + accidentScore

          // 서울이 아닐시
          if (!populationData['기준 장소']) {
            let accidentEa = document.getElementById('incident')
            accidentEa.innerHTML = '서울 지역만 조회 가능합니다.'
            accidentEa.style.color = 'black'
          }

          // 점수 합계가 0~3 사이임에도 재난 상황이 발생했다면 '위험'을 빨강색으로 표시하고 메세지 출력
          // 사건 사고 점수가 없다면 인구 점수 만으론 3점이 최대이기 때문에
          if (totalScore >= 0 && totalScore <= 3) {
            const containsEmergencyKeyword = filteredDisasterData.some(data => keywords.some(keyword => data.message.includes(keyword)));
            if (containsEmergencyKeyword) {
              filteredDisasterData.forEach(data => {
                emergencyElement.innerHTML += data.message + '<br>';
              });
              riskLevelElement.innerHTML = '위험';
              riskLevelElement.style.color = 'red';
              corongImage.src = 'https://postfiles.pstatic.net/MjAyNDA0MjBfMTA2/MDAxNzEzNjA2NDk5Nzk2.RFnFMYJw-yNigAbQXpE9n4oHzhQDZVYYZwRcvy51m0sg.U8rK9fI9Tbd7VP3KsCI4M8-DyMUhLH4gIWPRScnVZM4g.PNG/%EC%BD%94%EB%A1%B1%EC%9D%B4_%EB%A0%88%EB%93%9C.png?type=w580'
            } else {
              // 재난 상황이 발생 안했다면 기준에 맞게 변경
              if (totalScore >= 0 && totalScore <= 2) {
                riskLevelElement.innerHTML = '안전';
                riskLevelElement.style.color = 'green';
                corongImage.src = 'https://postfiles.pstatic.net/MjAyNDA0MjBfMTgg/MDAxNzEzNjA2NDg3MzI3.sKvYltmXJ46If2ypG6IBHs8DKf22ogQWF8W9DwbKp7Mg.Hx7frtbDo3Lt2WDbaAwb5p1EhQhh_-CbshWOHSEwh40g.PNG/%EC%BD%94%EB%A1%B1%EC%9D%B4_%EA%B7%B8%EB%A6%B0.png?type=w580';
              } else if (totalScore == 3) {
                riskLevelElement.innerHTML = '주의';
                riskLevelElement.style.color = 'orange';
                corongImage.src = 'https://postfiles.pstatic.net/MjAyNDA0MjBfNjQg/MDAxNzEzNjA2NDk3NDY0.OfArP4BsxiSy79JghC6OOcxLO3lUqzo5QGuzeZMwTXsg.7AsKH6ExROwijk092ZrPbAu_kiRSHENPB56lL-MuHDgg.PNG/%EC%BD%94%EB%A1%B1%EC%9D%B4_%EC%98%A4%EB%A0%8C%EC%A7%80.png?type=w580'
              }
            }
          }
        } else // 사건 사고가 있다면 건수에 따른 점수 부여하고 점수 합산
        { // 서울이 아닐시
          if (!populationData) {
          let accidentEa = document.getElementById('incident')
          accidentEa.innerHTML = '서울 지역만 조회 가능합니다.'
          }

          let accidentEa = document.getElementById('incident')
          accidentEa.innerHTML = `${newsData.length}건`
          if (newsData.length === 1 || newsData.length === 2) {
            accidentScore += 1 
            accidentEa.style.color = 'green'
          }
          if (newsData.length === 3 || newsData.length === 4) {
            accidentScore += 2
            accidentEa.style.color = 'orange'
          }
          if (newsData.length >= 5) {
            accidentScore += 3
            accidentEa.style.color = 'red'
          }

          totalScore = congestScore + accidentScore
          
          // 사건 사고는 있지만 재난 상황 발생시
          if (totalScore >= 1 && totalScore <= 6) {
            const containsEmergencyKeyword = filteredDisasterData.some(data => keywords.some(keyword => data.message.includes(keyword)));
            if (containsEmergencyKeyword) {
              filteredDisasterData.forEach(data => {
                emergencyElement.innerHTML += data.message + '<br>';
              });
              riskLevelElement.innerHTML = '위험';
              riskLevelElement.style.color = 'red';
              corongImage.src = 'https://postfiles.pstatic.net/MjAyNDA0MjBfMTA2/MDAxNzEzNjA2NDk5Nzk2.RFnFMYJw-yNigAbQXpE9n4oHzhQDZVYYZwRcvy51m0sg.U8rK9fI9Tbd7VP3KsCI4M8-DyMUhLH4gIWPRScnVZM4g.PNG/%EC%BD%94%EB%A1%B1%EC%9D%B4_%EB%A0%88%EB%93%9C.png?type=w580'
            } else {
              // 사건 사고는 있지만 재난 상황이 아닐때
              if (totalScore >= 0 && totalScore <= 2) {
                riskLevelElement.innerHTML = '안전';
                riskLevelElement.style.color = 'green';
                corongImage.src = 'https://postfiles.pstatic.net/MjAyNDA0MjBfMTgg/MDAxNzEzNjA2NDg3MzI3.sKvYltmXJ46If2ypG6IBHs8DKf22ogQWF8W9DwbKp7Mg.Hx7frtbDo3Lt2WDbaAwb5p1EhQhh_-CbshWOHSEwh40g.PNG/%EC%BD%94%EB%A1%B1%EC%9D%B4_%EA%B7%B8%EB%A6%B0.png?type=w580';
              } else if (totalScore == 3 || totalScore == 4) {
                riskLevelElement.innerHTML = '주의';
                riskLevelElement.style.color = 'orange';
                corongImage.src = 'https://postfiles.pstatic.net/MjAyNDA0MjBfNjQg/MDAxNzEzNjA2NDk3NDY0.OfArP4BsxiSy79JghC6OOcxLO3lUqzo5QGuzeZMwTXsg.7AsKH6ExROwijk092ZrPbAu_kiRSHENPB56lL-MuHDgg.PNG/%EC%BD%94%EB%A1%B1%EC%9D%B4_%EC%98%A4%EB%A0%8C%EC%A7%80.png?type=w580'
              } else if (totalScore == 5 || totalScore == 6) {
                riskLevelElement.innerHTML = '위험';
                riskLevelElement.style.color = 'red';
                corongImage.src = 'https://postfiles.pstatic.net/MjAyNDA0MjBfMTA2/MDAxNzEzNjA2NDk5Nzk2.RFnFMYJw-yNigAbQXpE9n4oHzhQDZVYYZwRcvy51m0sg.U8rK9fI9Tbd7VP3KsCI4M8-DyMUhLH4gIWPRScnVZM4g.PNG/%EC%BD%94%EB%A1%B1%EC%9D%B4_%EB%A0%88%EB%93%9C.png?type=w580'
              }
            }
          }
        }       
        } catch (error) {
          console.error('위치 정보 접근이 거부되거나 에러가 발생했습니다.:', error)
        }
      document.getElementById('searchButton').addEventListener('click', () => {
        let searchInput = document.getElementById('searchInput').value
        let url = `./destination-detail.html?destination=${encodeURIComponent(searchInput)}`
        window.location.href = url
      })
  })
    </script>
  </head>
  <body>
    <header><!-- sos,notification과 연결하는 파일 못찾아서 추가 해야함-->
      <image
        src="./images/free-icon-notification-3119322.png"
        class="header-image"
      ></image>
      <h1>CODE:RED</h1>
      <button id="sos">sos</button>
    </header>

    <main>
      <p id="divide"></p>
      <br />

      <div id="user-location">나의 현재 위치 : </div>

      <div id="closest-shelter">가까운 대피소 : </div>

      <div id="emergency" style="width: 450px; max-height: 120px; font-weight: bold; font-size: 24px; color: red;"></div>

      <h2 id="riskLevel">CODE : RED</h2>
      <img
        src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FoFvs6%2FbtsGHblHYxt%2F1kXhsa7cOG2FcjC2UzUIF1%2Fimg.png"
        alt="프로필 사진"
        id="corong-image"
      />

      <table>
        <tr>
          <th id="population">인구 밀집</th>
          <th id="population">인구 추이</th>
          <th id="disaster">재난 현황</th>
          <th id="accident">사건 / 사고</th>
        </tr>

        <tr>
          <td id="congest">CODE : RED</td>
          <td id="transition">CODE : RED</td>
          <td id="calamity">CODE : RED</td>
          <td id="incident">CODE : RED</td>
        </tr>
      </table>
      <div style="color: gray" id="time">위험도 측정 기준 : CODE : RED</div>
    </main>

    <form action="" id="inputButton">
      <input
        type="text, submit"
        id="searchInput"
        placeholder="이동할 목적지를 입력해주세요."
      />
      <button id="searchButton" type="button" >검색</button>
    </form>

    <footer>
      <a href="./main.html"
        ><image
          src="./images/free-icon-home-4690939.png"
          class="footer-image"
        ></image
      ></a>
      <a href="./findshelter.html"
        ><image
          src="./images/free-icon-search-149852.png"
          class="footer-image"
        ></image
      ></a>
      <a href="./chat-list.html"
        ><image
          src="./images/free-icon-bubble-chat-2076218.png"
          class="footer-image"
        ></image
      ></a>
      <a href="./exchange.html"
        ><image
          src="./images/free-icon-exchange-9788303.png"
          class="footer-image"
        ></image
      ></a>
      <a href="./myinfo.html"
        ><image
          src="./images/free-icon-user-3856336.png"
          class="footer-image"
        ></image
      ></a>
    </footer>
  </body>
</html>
